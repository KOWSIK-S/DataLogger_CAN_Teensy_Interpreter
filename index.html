<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MotoStudent Advanced Telemetry Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@2.0.1/dist/chartjs-chart-matrix.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>
    <style>
        body {
            background-color: #111827;
            color: #d1d5db;
        }
        .stat-card {
            background-color: #1f2937;
            border: 1px solid #374151;
            border-radius: 0.75rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
        .chart-container {
            background-color: #1f2937;
            border: 1px solid #374151;
            border-radius: 0.75rem;
            padding: 1.5rem;
        }
        .tab-button {
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
        }
        .tab-button.active {
            color: #38bdf8;
            border-bottom-color: #38bdf8;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px;
            background-color: #374151;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        #file-drop-zone {
            border: 2px dashed #374151;
            transition: all 0.3s ease;
        }
        #file-drop-zone.dragover {
            border-color: #38bdf8;
            background-color: #374151;
        }
        .loader {
            border: 8px solid #374151;
            border-top: 8px solid #38bdf8;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="font-sans">
    <div class="container mx-auto p-4 md:p-8">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-white mb-2">MotoStudent Advanced Telemetry Analysis</h1>
            <p class="text-lg text-gray-400">An in-browser dashboard for engine performance and CAN bus diagnostics.</p>
        </header>

        <!-- File Upload Section -->
        <div id="upload-section" class="mb-8">
            <div id="file-drop-zone" class="p-10 text-center rounded-lg cursor-pointer">
                <input type="file" id="csv-files" multiple accept=".csv" class="hidden">
                <label for="csv-files" class="w-full">
                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>
                    <p class="mt-4 text-xl text-gray-200">
                        <span class="font-semibold text-sky-400">Upload session files</span> or drag and drop
                    </p>
                    <p class="text-sm text-gray-500">Select all LOG_XXX.CSV files for a single session</p>
                </label>
            </div>
            <div id="file-list" class="mt-4 text-center"></div>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="hidden flex-col items-center justify-center my-16">
            <div class="loader"></div>
            <p id="loading-text" class="mt-4 text-xl text-gray-300">Processing files...</p>
        </div>

        <!-- Analysis Section -->
        <div id="analysis-section" class="hidden">
            <!-- Tabs -->
            <div class="mb-8 border-b border-gray-700">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button class="tab-button active" data-tab="overview">Session Overview</button>
                    <button class="tab-button" data-tab="performance">Engine Performance</button>
                    <button class="tab-button" data-tab="fuel">Fuel & Combustion</button>
                    <button class="tab-button" data-tab="diagnostics">CAN Bus Diagnostics</button>
                    <button class="tab-button" data-tab="inspector">Data Inspector</button>
                </nav>
            </div>
            
            <!-- Tab Content -->
            <div id="tab-content">
                <!-- Session Overview -->
                <div id="overview" class="tab-panel">
                    <h2 class="text-3xl font-bold text-white mb-6">Session Overview</h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-6 mb-8">
                        <div class="stat-card">
                            <h3 class="text-gray-400 text-sm font-medium">Max RPM</h3>
                            <p id="stat-max-rpm" class="text-3xl font-semibold text-white">0</p>
                            <p class="text-sm text-gray-500">RPM</p>
                        </div>
                        <div class="stat-card">
                            <h3 class="text-gray-400 text-sm font-medium">Max Coolant Temp</h3>
                            <p id="stat-max-temp" class="text-3xl font-semibold text-white">0</p>
                             <p class="text-sm text-gray-500">°C</p>
                        </div>
                        <div class="stat-card">
                            <h3 class="text-gray-400 text-sm font-medium">Session Duration</h3>
                            <p id="stat-duration" class="text-3xl font-semibold text-white">0:00</p>
                             <p class="text-sm text-gray-500">min:sec</p>
                        </div>
                        <div class="stat-card">
                            <h3 class="text-gray-400 text-sm font-medium">Total Gear Shifts</h3>
                            <p id="stat-shifts" class="text-3xl font-semibold text-white">0</p>
                             <p class="text-sm text-gray-500">Shifts</p>
                        </div>
                        <div class="stat-card">
                            <h3 class="text-gray-400 text-sm font-medium">CAN Timeouts</h3>
                            <p id="stat-timeouts" class="text-3xl font-semibold text-red-500">0</p>
                             <p class="text-sm text-gray-500">Events</p>
                        </div>
                        <div class="stat-card">
                            <h3 class="text-gray-400 text-sm font-medium">Data Integrity</h3>
                            <p id="stat-integrity" class="text-3xl font-semibold text-green-500">N/A</p>
                             <p class="text-sm text-gray-500">CRC Check</p>
                        </div>
                    </div>

                    <div class="chart-container">
                         <h3 class="text-xl font-semibold text-white mb-4 flex items-center">
                            Main Vitals Dashboard
                            <div class="tooltip ml-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                                <span class="tooltiptext">A synchronized overview of the key performance indicators over the entire session. This view helps correlate driver input (TPS) with engine response (RPM) and state (Temperature, Gear).</span>
                            </div>
                        </h3>
                        <canvas id="vitalsChart"></canvas>
                    </div>
                </div>

                <!-- Engine Performance -->
                <div id="performance" class="tab-panel hidden">
                    <h2 class="text-3xl font-bold text-white mb-6">Engine Performance Analysis</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="chart-container">
                            <h3 class="text-xl font-semibold text-white mb-4 flex items-center">
                                RPM Operating Range per Gear
                                <div class="tooltip ml-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                                    <span class="tooltiptext">This scatter plot shows the RPM range used in each gear. Ideal performance comes from keeping the engine in its power band (typically high RPMs) for each gear. Wide vertical spreads may indicate inefficient gear selection.</span>
                                </div>
                            </h3>
                            <canvas id="rpmGearChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3 class="text-xl font-semibold text-white mb-4 flex items-center">
                                Gear Usage Distribution
                                <div class="tooltip ml-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                                    <span class="tooltiptext">This histogram shows the percentage of the session time spent in each gear. This is crucial for optimizing gear ratios for a specific track. For example, a high percentage of time in one gear may suggest a ratio change could improve acceleration.</span>
                                </div>
                            </h3>
                            <canvas id="gearUsageChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Fuel & Combustion -->
                <div id="fuel" class="tab-panel hidden">
                     <h2 class="text-3xl font-bold text-white mb-6">Fuel & Combustion Analysis</h2>
                     <div class="chart-container">
                            <h3 class="text-xl font-semibold text-white mb-4 flex items-center">
                                Lambda vs. RPM & Throttle (Fuel Map)
                                 <div class="tooltip ml-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                                    <span class="tooltiptext">This heatmap visualizes the engine's air-fuel ratio (Lambda) across its operating range. Red areas are 'rich' (more fuel, Lambda < 1.0), ideal for max power. Blue areas are 'lean' (less fuel, Lambda > 1.0), for efficiency. This is the most critical chart for engine tuning.</span>
                                </div>
                            </h3>
                        <canvas id="fuelMapChart" height="150"></canvas>
                    </div>
                </div>
                
                <!-- CAN Bus Diagnostics -->
                <div id="diagnostics" class="tab-panel hidden">
                    <h2 class="text-3xl font-bold text-white mb-6">CAN Bus Diagnostics</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="chart-container">
                            <h3 class="text-xl font-semibold text-white mb-4 flex items-center">
                                Data Integrity Check (CRC)
                                 <div class="tooltip ml-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                                    <span class="tooltiptext">This verifies the integrity of every line in your log files using the CRC checksum generated by the logger. 100% valid data is critical for accurate analysis. Any corruption indicates potential issues with the SD card or logger hardware.</span>
                                </div>
                            </h3>
                            <canvas id="integrityChart" height="150"></canvas>
                             <div id="integrity-summary" class="text-center mt-4"></div>
                        </div>
                         <div class="chart-container">
                            <h3 class="text-xl font-semibold text-white mb-4 flex items-center">
                                CAN Message Frequency
                                 <div class="tooltip ml-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                                    <span class="tooltiptext">This chart shows how many messages per second (Hz) are being received for key CAN IDs. Consistent frequencies are a sign of a healthy bus. Drop-offs or erratic rates can indicate ECU load issues, bus congestion, or wiring problems.</span>
                                </div>
                            </h3>
                             <canvas id="frequencyChart" height="150"></canvas>
                        </div>
                    </div>
                    <div class="chart-container mt-8">
                        <h3 class="text-xl font-semibold text-white mb-4">CAN Timeout Event Log</h3>
                        <div class="overflow-auto max-h-96">
                            <table class="min-w-full divide-y divide-gray-700">
                                <thead class="bg-gray-800">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Event #</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Timestamp (Session Time)</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Description</th>
                                    </tr>
                                </thead>
                                <tbody id="timeout-log-body" class="bg-gray-900 divide-y divide-gray-700">
                                    <!-- Log entries will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Data Inspector -->
                <div id="inspector" class="tab-panel hidden">
                     <h2 class="text-3xl font-bold text-white mb-6">Raw Data Inspector</h2>
                     <div class="chart-container">
                        <div class="overflow-auto max-h-[70vh]">
                             <table class="min-w-full divide-y divide-gray-700">
                                <thead id="inspector-thead" class="bg-gray-800 sticky top-0">
                                </thead>
                                <tbody id="inspector-tbody" class="bg-gray-900 divide-y divide-gray-700">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Element References ---
        const uploadSection = document.getElementById('upload-section');
        const fileInput = document.getElementById('csv-files');
        const fileDropZone = document.getElementById('file-drop-zone');
        const fileList = document.getElementById('file-list');
        const loadingState = document.getElementById('loading-state');
        const loadingText = document.getElementById('loading-text');
        const analysisSection = document.getElementById('analysis-section');
        const tabs = document.querySelectorAll('.tab-button');
        const panels = document.querySelectorAll('.tab-panel');

        // --- Chart Objects ---
        let charts = {};
        
        // --- Global Data Store ---
        let masterData = [];

        // --- File Handling Logic ---
        fileDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileDropZone.classList.add('dragover');
        });
        fileDropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            fileDropZone.classList.remove('dragover');
        });
        fileDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            fileDropZone.classList.remove('dragover');
            fileInput.files = e.dataTransfer.files;
            handleFiles(fileInput.files);
        });
        fileInput.addEventListener('change', () => handleFiles(fileInput.files));
        
        function handleFiles(files) {
            if (files.length === 0) return;
            
            uploadSection.classList.add('hidden');
            loadingState.style.display = 'flex';
            
            let fileArray = Array.from(files);
            
            // Sort files naturally (LOG_1, LOG_2, LOG_10)
            fileArray.sort((a, b) => {
                const numA = parseInt(a.name.match(/(\d+)/)[0], 10);
                const numB = parseInt(b.name.match(/(\d+)/)[0], 10);
                return numA - numB;
            });
            
            fileList.innerHTML = `Processing ${fileArray.length} files: ${fileArray.map(f => f.name).join(', ')}`;
            
            let promises = fileArray.map(file => {
                return new Promise((resolve, reject) => {
                    Papa.parse(file, {
                        header: true,
                        skipEmptyLines: true,
                        dynamicTyping: true,
                        complete: (results) => resolve(results.data),
                        error: (err) => reject(err)
                    });
                });
            });

            Promise.all(promises).then(results => {
                stitchAndProcessData(results);
            }).catch(error => {
                console.error("Error parsing files:", error);
                loadingText.textContent = "Error processing files. Check console for details.";
            });
        }

        function stitchAndProcessData(fileDataArrays) {
            loadingText.textContent = "Stitching and verifying data...";
            let stitchedData = [];
            let lastTimestamp = 0;

            fileDataArrays.forEach(data => {
                if(data.length === 0) return;
                
                // Rename header from 'Time(ms)' etc. to valid keys
                const keyMap = {
                    'Time(ms)': 'Time_ms',
                    'RPM': 'RPM',
                    'TPS(%)': 'TPS',
                    'Coolant(C)': 'Coolant',
                    'MAP(mBar)': 'MAP',
                    'VBAT(V)': 'VBAT',
                    'Gear': 'Gear',
                    'Lambda1': 'Lambda1',
                    'CRC': 'CRC'
                };
                
                data = data.map(row => {
                    const newRow = {};
                    for(const key in row) {
                        const newKey = keyMap[key.trim()] || key.trim();
                        newRow[newKey] = row[key];
                    }
                    return newRow;
                });


                data.forEach(row => {
                    if (row.Time_ms === null || row.Time_ms === undefined) return;
                    let correctedRow = { ...row };
                    correctedRow.Time_ms += lastTimestamp;
                    stitchedData.push(correctedRow);
                });

                if (data.length > 0) {
                    const validTimeStamps = stitchedData.map(r => r.Time_ms).filter(t => t !== null && t !== undefined);
                    if (validTimeStamps.length > 0) {
                       lastTimestamp = Math.max(...validTimeStamps);
                    }
                }
            });
            
            masterData = stitchedData;
            
            // Use a short timeout to allow the UI to update before heavy analysis
            setTimeout(() => {
                runFullAnalysis();
                loadingState.style.display = 'none';
                analysisSection.classList.remove('hidden');
            }, 50);
        }

        // --- Analysis Logic ---
        function runFullAnalysis() {
            loadingText.textContent = "Analyzing data and generating charts...";
            
            // Destroy old charts if they exist
            Object.values(charts).forEach(chart => chart.destroy());
            
            const time_s = masterData.map(d => d.Time_ms / 1000);
            
            // Calculate stats
            const validData = masterData.filter(d => d.RPM !== -1);
            const maxRpm = Math.max(0, ...validData.map(d => d.RPM));
            const maxTemp = Math.max(0, ...validData.map(d => d.Coolant));
            const duration = time_s.length > 0 ? time_s[time_s.length - 1] : 0;
            const minutes = Math.floor(duration / 60);
            const seconds = Math.round(duration % 60).toString().padStart(2, '0');
            const shifts = calculateShifts(validData.map(d => d.Gear));
            const timeouts = masterData.filter(d => d.RPM === -1).length;
            const integrityResult = checkIntegrity();
            
            // Update stat cards
            document.getElementById('stat-max-rpm').textContent = maxRpm.toLocaleString();
            document.getElementById('stat-max-temp').textContent = maxTemp.toFixed(1);
            document.getElementById('stat-duration').textContent = `${minutes}:${seconds}`;
            document.getElementById('stat-shifts').textContent = shifts;
            document.getElementById('stat-timeouts').textContent = timeouts;
            document.getElementById('stat-integrity').textContent = `${integrityResult.percentage.toFixed(1)}%`;
            document.getElementById('stat-integrity').className = integrityResult.percentage > 99 ? 'text-3xl font-semibold text-green-500' : 'text-3xl font-semibold text-red-500';


            // --- Render Charts ---
            renderVitalsChart(time_s);
            renderRpmGearChart();
            renderGearUsageChart();
            renderFuelMapChart();
            renderIntegrityChart(integrityResult);
            renderFrequencyChart();
            populateTimeoutLog();
            populateDataInspector();
        }
        
        // --- Helper Functions ---
        function calculateShifts(gearData) {
            let shiftCount = 0;
            for (let i = 1; i < gearData.length; i++) {
                if (gearData[i] !== gearData[i-1] && gearData[i] !== -1 && gearData[i-1] !== -1) {
                    shiftCount++;
                }
            }
            return shiftCount;
        }

        function checkIntegrity() {
            let validCount = 0;
            let invalidCount = 0;

            masterData.forEach(row => {
                // Don't check timeout rows as their data is intentionally invalid
                if (row.RPM === -1 || typeof row.CRC === 'undefined') {
                    return;
                }
                
                // Reconstruct the line EXACTLY as the Teensy would have, before the CRC was added.
                // This is sensitive to formatting (number of decimal places).
                const dataLine_noCRC = `${row.Time_ms},${row.RPM},${row.TPS.toFixed(2)},${row.Coolant.toFixed(1)},${row.MAP.toFixed(1)},${row.VBAT.toFixed(2)},${row.Gear},${row.Lambda1.toFixed(3)}`;
                
                let calculatedCrc = 0;
                for (let i = 0; i < dataLine_noCRC.length; i++) {
                    calculatedCrc ^= dataLine_noCRC.charCodeAt(i);
                }
                
                if (calculatedCrc === row.CRC) {
                    validCount++;
                } else {
                    invalidCount++;
                }
            });

            const total = validCount + invalidCount;
            return { 
                valid: validCount, 
                invalid: invalidCount, 
                total: total, 
                percentage: total > 0 ? (validCount / total) * 100 : 100 
            };
        }
        
        // --- Chart Rendering Functions ---
        function renderVitalsChart(time_s) {
            const ctx = document.getElementById('vitalsChart').getContext('2d');
            
            const tempThresholds = {
                cold: 80, // As per engine info, warm-up is crucial
                optimal_end: 100, // Max optimal temp
                overheat: 100
            };

            charts.vitals = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: time_s,
                    datasets: [
                        {
                            label: 'RPM',
                            data: masterData.map(d => d.RPM === -1 ? null : d.RPM),
                            borderColor: '#f97316',
                            yAxisID: 'yRPM',
                            tension: 0.1,
                            pointRadius: 0
                        },
                        {
                            label: 'TPS (%)',
                            data: masterData.map(d => d.TPS === -1 ? null : d.TPS),
                            borderColor: '#38bdf8',
                            yAxisID: 'yTPS',
                            tension: 0.1,
                            pointRadius: 0
                        },
                        {
                            label: 'Coolant (°C)',
                            data: masterData.map(d => d.Coolant === -1 ? null : d.Coolant),
                            borderColor: '#eab308',
                            yAxisID: 'yCoolant',
                            tension: 0.1,
                            pointRadius: 0
                        },
                        {
                            label: 'Gear',
                            data: masterData.map(d => d.Gear === -1 ? null : d.Gear),
                            borderColor: '#a855f7',
                            yAxisID: 'yGear',
                            stepped: true,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            title: { display: true, text: 'Time (s)', color: '#9ca3af' },
                            ticks: { color: '#9ca3af' }
                        },
                        yRPM: {
                            type: 'linear', position: 'left',
                            title: { display: true, text: 'RPM', color: '#f97316' },
                            ticks: { color: '#f97316' },
                            max: 15000 // Engine limit is 14,000, give some headroom
                        },
                        yTPS: {
                            type: 'linear', position: 'right',
                            title: { display: true, text: 'TPS (%)', color: '#38bdf8' },
                            ticks: { color: '#38bdf8' },
                            max: 100, min: 0
                        },
                        yCoolant: {
                            type: 'linear', position: 'right', display: false,
                            max: 120, min: 20
                        },
                        yGear: {
                             type: 'linear', position: 'right', display: false,
                            max: 6, min: 0
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#d1d5db' } },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    animation: {
                        onComplete: ({ chart }) => {
                            const yAxis = chart.scales.yCoolant;
                            const { ctx, chartArea: { left, right, top, bottom } } = chart;
                            
                            const yOptimalStart = yAxis.getPixelForValue(tempThresholds.cold);
                            const yOptimalEnd = yAxis.getPixelForValue(tempThresholds.optimal_end);
                            
                            ctx.save();
                            ctx.fillStyle = 'rgba(74, 222, 128, 0.1)';
                            ctx.fillRect(left, yOptimalEnd, right - left, yOptimalStart - yOptimalEnd);
                            
                            ctx.fillStyle = 'rgba(239, 68, 68, 0.1)';
                            ctx.fillRect(left, top, right - left, yOptimalEnd - top);
                            
                            ctx.restore();
                        }
                    }
                }
            });
        }
        
        function renderRpmGearChart() {
            const ctx = document.getElementById('rpmGearChart').getContext('2d');
            const data = masterData.filter(d => d.Gear > 0).map(d => ({ x: d.RPM, y: d.Gear }));
            charts.rpmGear = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'RPM vs Gear',
                        data: data,
                        backgroundColor: 'rgba(56, 189, 248, 0.6)'
                    }]
                },
                options: {
                    scales: {
                        x: { title: { display: true, text: 'RPM', color: '#9ca3af' }, ticks: { color: '#9ca3af' } },
                        y: { title: { display: true, text: 'Gear', color: '#9ca3af' }, ticks: { color: '#9ca3af', stepSize: 1 } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderGearUsageChart() {
            const ctx = document.getElementById('gearUsageChart').getContext('2d');
            const gearCounts = {};
            masterData.filter(d => d.Gear > 0).forEach(d => {
                gearCounts[d.Gear] = (gearCounts[d.Gear] || 0) + 1;
            });
            const total = Object.values(gearCounts).reduce((a, b) => a + b, 0);
            const labels = Object.keys(gearCounts).sort((a,b) => a-b);
            const data = labels.map(label => (gearCounts[label] / total) * 100);

            charts.gearUsage = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.map(l => `Gear ${l}`),
                    datasets: [{
                        label: '% of Time',
                        data: data,
                        backgroundColor: '#60a5fa'
                    }]
                },
                options: {
                     indexAxis: 'y',
                     scales: {
                        x: { title: { display: true, text: '% of Session Time', color: '#9ca3af' }, ticks: { color: '#9ca3af' } },
                        y: { ticks: { color: '#9ca3af' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        function renderFuelMapChart() {
            const ctx = document.getElementById('fuelMapChart').getContext('2d');
            const data = masterData
                .filter(d => d.RPM > 1500 && d.TPS > 5)
                .map(d => ({
                    x: Math.round(d.RPM / 500) * 500,
                    y: Math.round(d.TPS / 5) * 5,
                    v: d.Lambda1
                }));

            // Average lambda values for each x,y bucket
            const aggregated = {};
            data.forEach(d => {
                const key = `${d.x}-${d.y}`;
                if (!aggregated[key]) {
                    aggregated[key] = { sum: 0, count: 0, x: d.x, y: d.y };
                }
                if (typeof d.v === 'number' && isFinite(d.v)) {
                   aggregated[key].sum += d.v;
                   aggregated[key].count++;
                }
            });

            const heatmapData = Object.values(aggregated).map(d => ({
                x: d.x,
                y: d.y,
                v: d.count > 0 ? d.sum / d.count : null
            })).filter(d => d.v !== null);

            charts.fuelMap = new Chart(ctx, {
                type: 'matrix',
                data: {
                    datasets: [{
                        label: 'Lambda',
                        data: heatmapData,
                        backgroundColor(ctx) {
                            const value = ctx.dataset.data[ctx.dataIndex].v;
                            if (value === null) return 'transparent';
                            // HSL color mapping: Red (rich, <1) -> Yellow (stoich, ~1) -> Blue (lean, >1)
                            const hue = 240 * (1 - (Math.min(Math.max(value, 0.8), 1.2) - 0.8) / 0.4);
                            return `hsla(${hue}, 100%, 50%, 0.8)`;
                        },
                        width: (ctx) => (ctx.chart.chartArea.width / (14000/500)),
                        height: (ctx) => (ctx.chart.chartArea.height / (100/5))
                    }]
                },
                options: {
                    scales: {
                        x: { type: 'linear', title: { display: true, text: 'RPM', color: '#9ca3af' }, ticks: { color: '#9ca3af' } },
                        y: { type: 'linear', title: { display: true, text: 'TPS (%)', color: '#9ca3af' }, ticks: { color: '#9ca3af' } }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                             callbacks: {
                                title: () => null,
                                label: (ctx) => `Lambda: ${ctx.dataset.data[ctx.dataIndex].v.toFixed(3)} @ ${ctx.dataset.data[ctx.dataIndex].x} RPM, ${ctx.dataset.data[ctx.dataIndex].y}% TPS`
                            }
                        }
                    }
                }
            });
        }
        
        function renderIntegrityChart(result) {
            const ctx = document.getElementById('integrityChart').getContext('2d');
            charts.integrity = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Valid Data', 'Corrupted Data'],
                    datasets: [{
                        data: [result.valid, result.invalid],
                        backgroundColor: ['#22c55e', '#ef4444'],
                        borderColor: '#1f2937'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top', labels: { color: '#d1d5db' } },
                        title: { display: true, text: 'Log File Data Integrity', color: '#d1d5db' }
                    }
                }
            });
            document.getElementById('integrity-summary').innerHTML = `<p class="text-lg text-gray-300">${result.valid.toLocaleString()} of ${result.total.toLocaleString()} lines verified.</p>`;
        }
        
        function renderFrequencyChart() {
            const ctx = document.getElementById('frequencyChart').getContext('2d');
            const idCounts = {};
            const duration = masterData.length > 0 ? masterData[masterData.length - 1].Time_ms / 1000 : 0;
            if (duration === 0) return;

            // This is a simulation, as we don't have raw CAN IDs in the stitched log.
            // We'll estimate based on the presence of data.
            idCounts['0x5F0 (RPM/TPS)'] = masterData.filter(d=>d.RPM !== undefined && d.RPM !== -1).length;
            idCounts['0x5F2 (Temps)'] = masterData.filter(d=>d.Coolant !== undefined && d.Coolant !== -1).length;
            idCounts['0x5F4 (Gear/VBat)'] = masterData.filter(d=>d.Gear !== undefined && d.Gear !== -1).length;
            idCounts['0x5F6 (Lambda)'] = masterData.filter(d=>d.Lambda1 !== undefined && d.Lambda1 !== -1).length;
            
            const labels = Object.keys(idCounts);
            const data = labels.map(label => idCounts[label] / duration);

            charts.frequency = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Frequency (Hz)',
                        data,
                        backgroundColor: '#a78bfa'
                    }]
                },
                options: {
                    scales: {
                        x: { ticks: { color: '#9ca3af' } },
                        y: { title: { display: true, text: 'Messages/Sec (Hz)', color: '#9ca3af' }, ticks: { color: '#9ca3af' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        function populateTimeoutLog() {
            const tbody = document.getElementById('timeout-log-body');
            tbody.innerHTML = '';
            let timeoutCount = 0;
            masterData.forEach((row, index) => {
                if (row.RPM === -1) {
                    timeoutCount++;
                    const timestamp = row.Time_ms / 1000;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${timeoutCount}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${timestamp.toFixed(3)} s</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-red-400">CAN bus communication lost</td>
                    `;
                    tbody.appendChild(tr);
                }
            });
            if (timeoutCount === 0) {
                 tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">No timeout events recorded.</td></tr>';
            }
        }
        
        function populateDataInspector() {
            const thead = document.getElementById('inspector-thead');
            const tbody = document.getElementById('inspector-tbody');
            thead.innerHTML = '';
            tbody.innerHTML = '';

            if(masterData.length === 0) return;
            const headers = Object.keys(masterData[0]);
            let headerHtml = '<tr>';
            headers.forEach(h => {
                headerHtml += `<th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">${h}</th>`;
            });
            headerHtml += '</tr>';
            thead.innerHTML = headerHtml;

            let bodyHtml = '';
            masterData.slice(0, 500).forEach(row => { // Show first 500 rows for performance
                bodyHtml += '<tr>';
                headers.forEach(h => {
                     let val = row[h];
                     if (typeof val === 'number') {
                        // Avoid fixing an excessive number of decimals for integers
                        if (val % 1 !== 0) {
                            val = val.toFixed(3);
                        }
                     }
                     bodyHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${val === null ? 'N/A' : val}</td>`;
                });
                bodyHtml += '</tr>';
            });
            tbody.innerHTML = bodyHtml;
        }

        // --- Tab Navigation ---
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                panels.forEach(panel => panel.classList.add('hidden'));
                document.getElementById(tab.dataset.tab).classList.remove('hidden');
            });
        });
    });
    </script>
</body>
</html>

